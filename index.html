<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scribblit</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .container {
            display: flex;
            flex-grow: 1;
        }
        .left-column {
            flex: 1;
            padding-right: 20px;
        }
        .right-column {
            flex: 1;
            border-left: 1px solid #ccc;
            padding-left: 20px;
        }
        #taskInput {
            width: 100%;
            height: 100px;
            margin-bottom: 20px;
        }
        #taskList {
            list-style-type: none;
            padding: 0;
        }
        #calendar {
            position: relative;
            height: 600px;
            overflow-y: auto;
        }
        .calendar-event {
            position: absolute;
            left: 0;
            right: 0;
            padding: 5px;
            margin: 1px;
            background-color: #007bff;
            color: white;
            border-radius: 3px;
            font-size: 12px;
        }
        .calendar-event.partial {
            background: linear-gradient(to bottom, #007bff 0%, transparent 100%);
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Scribblit</h1>
    <div class="container">
        <div class="left-column">
            <textarea id="taskInput" placeholder="Scribble your tasks here..."></textarea>
            <h2>Daily Untimed Tasks</h2>
            <ul id="taskList"></ul>
        </div>
        <div class="right-column">
            <div class="navigation">
                <button id="prevDay">&lt;</button>
                <span id="currentDate">Today</span>
                <button id="nextDay">&gt;</button>
            </div>
            <div id="calendar"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/2.3.1/luxon.min.js"></script>
    <script>
        const DateTime = luxon.DateTime;
        let currentDate = DateTime.local();
        const apiKey = 'AIzaSyDgiM5ZhWqxsI_hoNAaJeSChCh5SkztGoc';

        const taskInput = document.getElementById('taskInput');
        const taskList = document.getElementById('taskList');
        const calendar = document.getElementById('calendar');
        const currentDateEl = document.getElementById('currentDate');
        const prevDayBtn = document.getElementById('prevDay');
        const nextDayBtn = document.getElementById('nextDay');

        taskInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                processInput();
            }
        });

        prevDayBtn.addEventListener('click', () => changeDate(-1));
        nextDayBtn.addEventListener('click', () => changeDate(1));

        function changeDate(delta) {
            currentDate = currentDate.plus({ days: delta });
            updateDateDisplay();
            renderCalendar();
        }

        function updateDateDisplay() {
            const today = DateTime.local();
            if (currentDate.hasSame(today, 'day')) {
                currentDateEl.textContent = 'Today';
            } else if (currentDate.hasSame(today.plus({ days: 1 }), 'day')) {
                currentDateEl.textContent = 'Tomorrow';
            } else if (currentDate.hasSame(today.minus({ days: 1 }), 'day')) {
                currentDateEl.textContent = 'Yesterday';
            } else {
                currentDateEl.textContent = currentDate.toFormat('M/d');
            }
        }

        async function processInput() {
            const input = taskInput.value;
            taskInput.value = '';

            const prompt = `
            You are a task parsing AI. You will receive a list of tasks or events, potentially messy or informal. Your job is to format and structure this information.

            For each task or event:
            1. Apply proper formatting and capitalization.
            2. Infer the date. If no date is specified, assume it's for today (${currentDate.toFormat('yyyy-MM-dd')}). If "tomorrow" or a day of the week is mentioned, calculate the actual date.
            3. Determine the time, if applicable. If it's past noon and only a number is given (e.g., "at 3"), assume PM. Use reasoning to guess AM/PM when not explicitly stated.

            Respond with a JSON array. Each item should have these properties:
            - name: The formatted task name
            - date: In YYYY-MM-DD format
            - startTime: In HH:mm format (24-hour)
            - endTime: In HH:mm format (24-hour)

            If a field cannot be inferred, omit it. For example: if not time is given, don't provide the startTime or endTime fields. The tasks you are given are written very quickly and hastily, so you should expand parts where they meant a word but just typed a few characters. Like "HW" should be expanded to "Homework". This doesn't mean you should expand acronyms. Also remove words from the name that provide no value, like "due". So "slideshow due for Bio" should be "Slideshow for Bio".

            Input:
            ${input}

            Give me a JSON response and nothing else. Don't put it in a code block.`;

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + apiKey, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                console.log('Raw text:', rawText);
                
                // Remove Markdown formatting and parse JSON
                const jsonText = rawText.replace(/```json\n|\n```/g, '').trim();
                const parsedTasks = JSON.parse(jsonText);
                
                renderTasks(parsedTasks);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderTasks(tasks) {
            taskList.innerHTML = '';
            calendar.innerHTML = '';

            tasks.forEach(task => {
                if (!task.startTime) {
                    // This is an untimed task
                    const li = document.createElement('li');
                    li.textContent = `${task.name} (${task.date})`;
                    taskList.appendChild(li);
                } else {
                    // This is a timed event
                    if (task.date === currentDate.toFormat('yyyy-MM-dd')) {
                        const eventEl = document.createElement('div');
                        eventEl.className = 'calendar-event';
                        eventEl.textContent = `${task.startTime} - ${task.name}`;
                        
                        const startMinutes = timeToMinutes(task.startTime);
                        eventEl.style.top = `${startMinutes / 1440 * 100}%`;
                        
                        if (task.endTime) {
                            const endMinutes = timeToMinutes(task.endTime);
                            const duration = endMinutes - startMinutes;
                            eventEl.style.height = `${duration / 1440 * 100}%`;
                        } else {
                            eventEl.classList.add('partial');
                            eventEl.style.height = '60px'; // 1 hour
                        }

                        calendar.appendChild(eventEl);
                    }
                }
            });
        }

        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function renderCalendar() {
            calendar.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const hourMarker = document.createElement('div');
                hourMarker.textContent = `${i}:00`;
                hourMarker.style.position = 'absolute';
                hourMarker.style.top = `${i / 24 * 100}%`;
                hourMarker.style.borderTop = '1px solid #ccc';
                hourMarker.style.width = '100%';
                calendar.appendChild(hourMarker);
            }
        }

        updateDateDisplay();
        renderCalendar();
    </script>
</body>
</html>