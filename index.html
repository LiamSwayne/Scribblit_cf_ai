<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scribblit</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .container {
            display: flex;
            flex-grow: 1;
        }
        .left-column {
            flex: 1;
            padding-right: 20px;
            display: flex;
            flex-direction: column;
        }
        .right-column {
            flex: 1;
            border-left: 1px solid #444;
            padding-left: 20px;
            position: relative;
            overflow: hidden;
        }
        #taskInput {
            width: 100%;
            height: 100px;
            margin-bottom: 20px;
            background-color: #2d2d2d;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px;
            resize: vertical;
            position: relative;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        #animationOverlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .animated-text {
            position: absolute;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #e0e0e0;
            padding: 10px;
            background-color: #2d2d2d;
            opacity: 0;
            animation: floatAway 1s forwards;
        }
        @keyframes floatAway {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }
        .task-section {
            margin-bottom: 20px;
        }
        .task-list {
            list-style-type: none;
            padding: 0;
        }
        .task-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        .task-date, .task-asterisk {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: #888;
            margin-right: 10px;
            min-width: 60px;
            text-align: right;
        }
        .task-asterisk {
            min-width: 20px;
        }
        #calendar {
            position: absolute;
            top: 40px;
            left: 20px;
            right: 0;
            bottom: 0;
            overflow-y: auto;
        }
        .calendar-event {
            position: absolute;
            left: 60px;
            right: 0;
            padding: 5px;
            margin: 1px;
            background-color: #3a506b;
            color: #e0e0e0;
            border-radius: 3px;
            font-size: 12px;
            box-sizing: border-box;
        }
        .calendar-event.partial {
            background: linear-gradient(to bottom, #3a506b 0%, transparent 100%);
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .navigation button {
            background-color: #3a506b;
            color: #e0e0e0;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .hour-marker {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 1px solid #444;
            pointer-events: none;
        }
        .hour-label {
            position: absolute;
            left: 0;
            width: 50px;
            text-align: right;
            padding-right: 5px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #888;
        }
        @keyframes slideUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100%); opacity: 0; }
        }
        @keyframes slideInRight {
            0% { transform: translateX(100%); }
            100% { transform: translateX(0); }
        }
        @keyframes slideInLeft {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <h1>Scribblit</h1>
    <div class="container">
        <div class="left-column">
            <div style="position: relative;">
                <textarea id="taskInput" placeholder="Scribble your tasks here..."></textarea>
                <div id="animationOverlay"></div>
            </div>
            <div class="task-section">
                <h2>Today</h2>
                <ul id="todayTaskList" class="task-list"></ul>
            </div>
            <div class="task-section">
                <h2>Tomorrow</h2>
                <ul id="tomorrowTaskList" class="task-list"></ul>
            </div>
            <div class="task-section">
                <h2>This Week</h2>
                <ul id="weekTaskList" class="task-list"></ul>
            </div>
        </div>
        <div class="right-column">
            <div class="navigation">
                <button id="prevDay">&lt;</button>
                <span id="currentDate">Today</span>
                <button id="nextDay">&gt;</button>
            </div>
            <div id="calendar"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/2.3.1/luxon.min.js"></script>
    <script>
        const DateTime = luxon.DateTime;
        let currentDate = DateTime.local();
        const apiKey = 'AIzaSyDgiM5ZhWqxsI_hoNAaJeSChCh5SkztGoc';

        const taskInput = document.getElementById('taskInput');
        const todayTaskList = document.getElementById('todayTaskList');
        const tomorrowTaskList = document.getElementById('tomorrowTaskList');
        const weekTaskList = document.getElementById('weekTaskList');
        const calendar = document.getElementById('calendar');
        const currentDateEl = document.getElementById('currentDate');
        const prevDayBtn = document.getElementById('prevDay');
        const nextDayBtn = document.getElementById('nextDay');

        taskInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                processInput();
            }
        });

        prevDayBtn.addEventListener('click', () => changeDate(-1, 'left'));
        nextDayBtn.addEventListener('click', () => changeDate(1, 'right'));

        function changeDate(delta, direction) {
            const oldCalendar = calendar.cloneNode(true);
            oldCalendar.style.position = 'absolute';
            oldCalendar.style.top = '40px';
            oldCalendar.style.left = '20px';
            oldCalendar.style.right = '0';
            oldCalendar.style.bottom = '0';
            calendar.parentNode.appendChild(oldCalendar);

            currentDate = currentDate.plus({ days: delta });
            updateDateDisplay();

            oldCalendar.style.animation = 'slideUp 0.5s forwards';
            calendar.style.animation = direction === 'right' ? 'slideInRight 0.5s forwards' : 'slideInLeft 0.5s forwards';

            setTimeout(() => {
                oldCalendar.remove();
                renderCalendar();
            }, 500);
        }

        function updateDateDisplay() {
            const today = DateTime.local();
            if (currentDate.hasSame(today, 'day')) {
                currentDateEl.textContent = 'Today';
            } else if (currentDate.hasSame(today.plus({ days: 1 }), 'day')) {
                currentDateEl.textContent = 'Tomorrow';
            } else if (currentDate.hasSame(today.minus({ days: 1 }), 'day')) {
                currentDateEl.textContent = 'Yesterday';
            } else {
                currentDateEl.textContent = currentDate.toFormat('M/d');
            }
        }

        async function processInput() {
            const taskInput = document.getElementById('taskInput');
            const input = taskInput.value;
            const animationOverlay = document.getElementById('animationOverlay');
            
            // Create animation
            const animatedText = document.createElement('div');
            animatedText.className = 'animated-text';
            
            // Copy the exact content structure
            animatedText.innerHTML = input.replace(/\n/g, '<br>');
            
            // Position the animated text precisely
            const inputRect = taskInput.getBoundingClientRect();
            const overlayRect = animationOverlay.getBoundingClientRect();
            
            animatedText.style.top = `${inputRect.top - overlayRect.top + taskInput.scrollTop}px`;
            animatedText.style.left = `${inputRect.left - overlayRect.left}px`;
            animatedText.style.width = `${inputRect.width}px`;
            animatedText.style.height = `${inputRect.height}px`;
            
            animationOverlay.appendChild(animatedText);

            // Clear input and wait for animation
            taskInput.value = '';
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for animation to complete

            // Clear animation overlay
            animationOverlay.innerHTML = '';

            const prompt = `
            You are a task parsing AI. You will receive a list of tasks or events, potentially messy or informal. Your job is to format and structure this information.

            For each task or event:
            1. Apply proper formatting and capitalization.
            2. Infer the date. If no date is specified, assume it's for today (${currentDate.toFormat('yyyy-MM-dd')}). If "tomorrow" or a day of the week is mentioned, calculate the actual date.
            3. Determine the time, if applicable. If it's past noon and only a number is given (e.g., "at 3"), assume PM. Use reasoning to guess AM/PM when not explicitly stated.

            Respond with a JSON array. Each item should have these properties:
            - name: The formatted task name
            - date: In YYYY-MM-DD format
            - startTime: In HH:mm format (24-hour)
            - endTime: In HH:mm format (24-hour)

            If a field cannot be inferred, omit it. For example: if not time is given, don't provide the startTime or endTime fields. The tasks you are given are written very quickly and hastily, so you should expand parts where they meant a word but just typed a few characters. Like "HW" should be expanded to "Homework". This doesn't mean you should expand acronyms. Also remove words from the name that provide no value, like "due". So "slideshow due for Bio" should be "Slideshow for Bio".

            Input:
            ${input}

            Give me a JSON response and nothing else. Don't put it in a code block.`;

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + apiKey, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                console.log('Raw text:', rawText);
                
                // Remove Markdown formatting and parse JSON
                const jsonText = rawText.replace(/```json\n|\n```/g, '').trim();
                const parsedTasks = JSON.parse(jsonText);
                
                renderTasks(parsedTasks);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderTasks(tasks) {
            todayTaskList.innerHTML = '';
            tomorrowTaskList.innerHTML = '';
            weekTaskList.innerHTML = '';
            calendar.innerHTML = '';

            renderCalendarTimeMarkers();

            const today = DateTime.local().toFormat('yyyy-MM-dd');
            const tomorrow = DateTime.local().plus({ days: 1 }).toFormat('yyyy-MM-dd');
            const weekEnd = DateTime.local().plus({ days: 7 }).toFormat('yyyy-MM-dd');

            tasks.forEach(task => {
                const taskDate = DateTime.fromISO(task.date);
                const listItem = document.createElement('li');
                
                if (task.date === today) {
                    const asterisk = document.createElement('span');
                    asterisk.className = 'task-asterisk';
                    asterisk.textContent = '*';
                    listItem.appendChild(asterisk);
                    listItem.appendChild(document.createTextNode(task.name));
                    todayTaskList.appendChild(listItem);
                } else if (task.date === tomorrow) {
                    const asterisk = document.createElement('span');
                    asterisk.className = 'task-asterisk';
                    asterisk.textContent = '*';
                    listItem.appendChild(asterisk);
                    listItem.appendChild(document.createTextNode(task.name));
                    tomorrowTaskList.appendChild(listItem);
                } else if (taskDate <= DateTime.fromISO(weekEnd) && task.date !== today && task.date !== tomorrow) {
                    const dateSpan = document.createElement('span');
                    dateSpan.className = 'task-date';
                    dateSpan.textContent = taskDate.toFormat('MM-dd');
                    listItem.appendChild(dateSpan);
                    listItem.appendChild(document.createTextNode(task.name));
                    weekTaskList.appendChild(listItem);
                }

                if (task.startTime && task.date === currentDate.toFormat('yyyy-MM-dd')) {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'calendar-event';
                    eventEl.textContent = `${task.startTime} - ${task.name}`;
                    
                    const startMinutes = timeToMinutes(task.startTime);
                    eventEl.style.top = `${startMinutes / 1440 * 100}%`;
                    
                    if (task.endTime) {
                        const endMinutes = timeToMinutes(task.endTime);
                        const duration = endMinutes - startMinutes;
                        eventEl.style.height = `calc(${duration / 1440 * 100}% - 2px)`;
                    } else {
                        eventEl.classList.add('partial');
                        eventEl.style.height = '60px'; // 1 hour
                    }

                    calendar.appendChild(eventEl);
                }
            });
        }

        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function renderCalendarTimeMarkers() {
            for (let i = 0; i < 24; i++) {
                const hourMarker = document.createElement('div');
                hourMarker.className = 'hour-marker';
                hourMarker.style.top = `${i / 24 * 100}%`;

                const hourLabel = document.createElement('div');
                hourLabel.className = 'hour-label';
                hourLabel.textContent = `${i.toString().padStart(2, '0')}:00`;
                hourLabel.style.top = `${i / 24 * 100}%`;

                calendar.appendChild(hourMarker);
                calendar.appendChild(hourLabel);
            }
        }

        function renderCalendar() {
            calendar.innerHTML = '';
            renderCalendarTimeMarkers();
        }

        updateDateDisplay();
        renderCalendar();
    </script>
</body>
</html>